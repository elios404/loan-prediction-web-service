<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base/default_layout}"> <!-- head, body 가 default_layout에 있기에 여기서는 제거 -->

<!-- default_layout에서 content에 들어가 것 만 만들면 됨. -->
<div layout:fragment="content">
    <h1>부서 목록</h1>
    <table border = "1" class="table table-hover" id="dept_table">
        <thead>
        <tr>
            <th>유저 아이디</th>
            <th>유저 이름</th>
            <th>유저 나이</th>
            <th>유저 성별</th>
            <th>유저 학교</th>
            <th>유저 집 소유 여부</th>
        </tr>
        </thead>

        <tbody>

        </tbody>

    </table>

    <div>
        <form action="./insert" method="post" id="frmForm">
            <ul>
                <li><label>유저 아이디 :</label> <input type="number" id="userId" name="userId" required></li>
                <li><label>유저 이름 :</label> <input type="text" id="name" name="name" maxlength="50" required></li>
                <li><label>유저 나이 :</label> <input type="number" id="age" name="age" min="0" step="1" required></li>
                <li>
                    <label>유저 성별 :</label>
                    <select id="gender" name="gender">
                        <option value="">선택</option>
                        <option value="male">남성</option>
                        <option value="female">여성</option>
                        <option value="etc">기타</option>
                    </select>
                </li>
                <li><label>유저 학교 :</label> <input type="text" id="education" name="education" maxlength="50" required></li>
                <li><label>유저 집 소유 :</label> <input type="text" id="homeOwnership" name="homeOwnership" maxlength="50" required></li>
            </ul>

            <button type="submit" class="btn btn-primary" id="btnNew">신규등록</button>
            <button type="submit" class="btn btn-warning" id="btnUpdate">수정저장</button>
            <button type="submit" class="btn btn-danger" id="btnDelete">삭제</button>
            <button type="button" class="btn btn-secondary" id="btnReset">메인 화면</button>

        </form>

    </div>

</div>

<div layout:fragment="script">
    <script>

        // ajax(비동기 요청 처리)
        function getDetail(userId) {
            $.get('/api/users/' + userId, {}, function (user) {
                $("#userId").val(user.userId);
                $("#name").val(user.name);
                $("#age").val(user.age);
                $("#gender").val(user.gender);
                $("#education").val(user.education);
                $("#homeOwnership").val(user.homeOwnership);
            });
        }

        function getList() {
            let result = '';

            $.get('/api/users', {}, function(data) {
                console.log(data);

                // userList 또는 users 배열로 응답이 올 것으로 예상
                // 실제 API 응답 구조에 맞게 수정 필요 (data.userList 또는 data.users 또는 data)
                const userList = data.userList;

                for(let user of userList) {
                    console.log(user);

                    // 사용자 정보를 테이블 행으로 생성
                    result += `
                <tr>
                    <td>${user.userId}</td>
                    <td><a href="#" class="details" data-userId="${user.userId}">${user.name}</a></td>
                    <td>${user.age}</td>
                    <td>${user.gender === 'male' ? '남성' : user.gender === 'female' ? '여성' : '기타'}</td>
                    <td>${user.education}</td>
                    <td>${user.homeOwnership}</td>
                </tr>
            `;
                }

                // 테이블 body에 결과 추가 (기존 내용 제거 후)
                $('#dept_table > tbody').empty().append(result);
            });
        }

        // DOM 생성 이후에 실행
        $(document).ready(function() {
            getList();
        })
            .on('click', '.details', function() {
                // 사용자 이름 클릭시 해당 사용자 상세 정보 조회
                const userId = $(this).attr('data-userId');
                console.log('Selected userId:', userId);
                getDetail(userId);
            });

        // 폼 제출 처리 (신규등록, 수정, 삭제)
        $('#frmForm').on('submit', function(e) {
            e.preventDefault(); // 기본 폼 제출 방지

            // 버튼별 HTTP 메소드 매핑
            const method = {
                'btnNew': 'POST',
                'btnUpdate': 'PUT',
                'btnDelete': 'DELETE'
            };

            const btn = event.submitter.id;
            console.log('Button clicked:', btn, 'Method:', method[btn]);

            let userId = '';

            // DELETE의 경우 URL에 userId 필요
            if (method[btn] === 'DELETE' || method[btn] === 'PUT') {
                userId = $('#userId').val();
                if (!userId) {
                    alert('수정/삭제할 사용자를 먼저 선택해주세요.');
                    return;
                }
            }

            // API 엔드포인트 URL 생성
            let apiUrl = '/api/users';
            if (method[btn] === 'PUT' || method[btn] === 'DELETE') {
                apiUrl += '/' + userId;
            }

            $.ajax({
                type: method[btn],
                url: apiUrl,
                data: method[btn] !== 'DELETE' ? $('#frmForm').serialize() : {},
                success: function(result) {
                    alert(result.message || '작업이 완료되었습니다.');
                    getList(); // 목록 새로고침
                    resetForm(); // 폼 초기화
                },
                error: function(request, status, error) {
                    console.log('Error:', error);
                    alert('작업 중 오류가 발생했습니다: ' + (request.responseJSON?.message || error));
                }
            });
        });

        // 폼 초기화 함수
        function resetForm() {
            $("#userId").val('');
            $("#name").val('');
            $("#age").val('');
            $("#gender").val('');
            $("#education").val('');
            $("#homeOwnership").val('');
        }

        // 메인 화면 버튼 클릭 처리
        $('#btnReset').on('click', function() {
            resetForm();
        });

    </script>

</div>

</html>